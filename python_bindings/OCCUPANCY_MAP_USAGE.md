# 占用地图生成功能使用指南

## 概述

这个工具扩展了ORB-SLAM3的轨迹可视化功能，增加了从轨迹数据生成2D占用地图（房间平面图）的能力。占用地图显示了机器人可以安全行走的区域，常用于导航规划和环境分析。

## 主要功能

1. **轨迹格式支持**：
   - TUM格式 (`timestamp tx ty tz qx qy qz qw`)
   - KITTI格式 (3x4变换矩阵的12个元素)
   - NumPy格式 (`.npz`文件包含poses, timestamps, frame_ids)

2. **占用地图生成**：
   - 从3D轨迹数据提取2D平面信息
   - 自动检测可行走区域
   - 推断障碍物和墙壁位置
   - 支持自定义机器人半径和地图分辨率

3. **多种输出格式**：
   - PGM格式（ROS标准，用于navigation stack）
   - YAML元数据文件（ROS地图格式）
   - NumPy格式（便于Python处理）

## 使用方法

### 基本用法

```bash
# 基本轨迹可视化
python visualize_trajectory.py --tum trajectory.txt

# 生成占用地图
python visualize_trajectory.py --tum trajectory.txt --occupancy
```

### 高级参数

```bash
# 自定义占用地图参数
python visualize_trajectory.py --tum trajectory.txt --occupancy \\
    --resolution 0.02 \\           # 地图分辨率（米/像素，默认0.05）
    --robot-radius 0.4 \\          # 机器人半径（米，默认0.3）
    --map-extension 1.5 \\         # 地图边界扩展（米，默认2.0）
    --save-map my_room_map         # 保存地图文件前缀
```

### 支持的所有格式

```bash
# TUM格式
python visualize_trajectory.py --tum trajectory.txt --occupancy

# KITTI格式
python visualize_trajectory.py --kitti poses.txt --occupancy

# NumPy格式
python visualize_trajectory.py --numpy trajectory.npz --occupancy
```

## 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--resolution` | float | 0.05 | 地图分辨率（米/像素）。值越小地图越精细 |
| `--robot-radius` | float | 0.3 | 机器人半径（米）。影响可行走区域的大小 |
| `--map-extension` | float | 2.0 | 地图边界扩展距离（米） |
| `--save-map` | string | 自动生成 | 保存地图的文件名前缀 |

## 输出文件

生成的地图文件包括：

1. **PGM文件**（`filename.pgm`）：
   - 灰度图像格式
   - 黑色（0）：障碍物/墙壁
   - 白色（255）：可行走区域
   - 灰色（127）：未探索区域

2. **YAML文件**（`filename.yaml`）：
   - ROS标准地图元数据
   - 包含分辨率、原点坐标等信息

3. **NumPy文件**（`filename.npz`）：
   - 包含占用地图数组和元数据
   - 便于Python程序处理

## 地图解释

### 颜色编码

- **白色区域**：可行走区域，机器人可以安全通过
- **黑色区域**：障碍物或墙壁，机器人无法通过
- **灰色区域**：未探索区域，机器人未曾到达
- **红色线条**：机器人实际轨迹

### 地图生成原理

1. **轨迹提取**：从3D轨迹数据提取XY平面坐标
2. **可行走区域标记**：在轨迹周围标记机器人半径范围内为可行走
3. **路径连接**：连接轨迹点之间的路径，形成连续的可行走走廊
4. **边界推断**：基于轨迹边界推断可能的墙壁和障碍物位置
5. **形态学处理**：平滑地图，填充小洞，优化边界

## 测试示例

运行测试脚本生成示例数据：

```bash
python test_occupancy_map.py
```

这将：
1. 生成模拟房间轨迹数据
2. 测试不同分辨率的地图生成
3. 创建TUM格式的示例文件
4. 显示统计信息和可视化结果

## 应用场景

### 1. 机器人导航
- 路径规划的环境地图
- 避障算法的输入数据
- 导航目标点的可达性分析

### 2. 环境分析
- 房间结构分析
- 可用空间计算
- 障碍物分布研究

### 3. SLAM评估
- 建图质量评估
- 轨迹覆盖度分析
- 探索效率计算

### 4. 数据集制作
- 为机器学习算法准备训练数据
- 创建标准化的环境地图
- 生成仿真环境的参考地图

## 技术细节

### 算法流程

1. **数据预处理**：
   - 加载轨迹数据
   - 提取位置信息
   - 计算地图边界

2. **栅格化**：
   - 创建栅格地图
   - 转换世界坐标到像素坐标
   - 初始化为未知区域

3. **可行走区域生成**：
   - 在轨迹点周围创建圆形可行走区域
   - 使用Bresenham算法连接轨迹点
   - 在连接线周围创建可行走走廊

4. **形态学优化**：
   - 膨胀操作扩展可行走区域
   - 腐蚀操作平滑边界
   - 填充小洞和间隙

5. **边界处理**：
   - 在地图边缘设置障碍物
   - 推断可能的墙壁位置

### 性能考虑

- **分辨率选择**：
  - 高分辨率（0.01-0.02m）：精细地图，适合小环境
  - 中分辨率（0.05m）：平衡质量和性能
  - 低分辨率（0.1m以上）：快速处理，适合大环境

- **内存使用**：地图大小 = (宽度/分辨率) × (高度/分辨率)
- **处理时间**：与轨迹点数和地图分辨率成正比

## 故障排除

### 常见问题

1. **地图过大**：
   - 减小分辨率值
   - 减少地图扩展距离
   - 裁剪轨迹数据范围

2. **可行走区域不连续**：
   - 增加机器人半径
   - 降低地图分辨率
   - 检查轨迹数据质量

3. **内存不足**：
   - 增加分辨率值
   - 分段处理长轨迹
   - 使用更高效的数据类型

### 依赖库要求

```bash
pip install numpy matplotlib opencv-python scipy scikit-image
```

## 扩展功能

可以进一步扩展的功能：

1. **多层地图**：支持多楼层环境
2. **动态障碍物**：处理移动物体
3. **语义标注**：添加房间类型标签
4. **路径规划**：集成A*等路径规划算法
5. **实时更新**：支持在线地图更新

---

有关更多技术细节和高级用法，请参考源代码注释或联系开发团队。
